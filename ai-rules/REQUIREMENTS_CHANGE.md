# 要件変更フロー

開発途中に機能追加・仕様変更・設計見直しが発生した際の対応フロー。

---

## トリガー判定

### 要件変更フローが必要なケース

ユーザーが以下のような発言をした場合、メインClaude Agentが要件変更と判断:

- 「新機能を追加したい」
- 「機能の仕様を変更したい」
- 「設計を見直したい」
- アーキテクチャに影響する変更
- 既存機能の大幅な改修

### 通常の会話で対応（要件変更フロー不要）

以下は要件変更フローを使わず、直接対応:

- パラメータ変更（ポート番号、タイムアウト値など）
- UI微調整（色、サイズ、配置）
- バグ修正
- ドキュメント修正
- 小さなリファクタリング

---

## フロー

### Phase 0: 作業の一時保存

**メインClaude Agentが実行**:

1. 現在の作業状態を確認
2. キリの良いところまで進める（必要なら）
   - 例: 実装中の関数を完成させる
   - 例: 現在のテストケースを完了させる
3. 一時保存を推奨

```bash
git add .
git commit -m "wip: 要件変更前の一時保存"
```

---

### Phase 1: 要件ヒアリング（Case A相当）

**メインClaude Agentが質問**:

1. 変更・追加したい機能は何ですか？（具体的に）
2. 想定ユーザーは誰ですか？（管理者/一般ユーザー/etc.）
3. 既存機能との関連は？（独立/既存機能拡張/既存機能変更）
4. 優先度は？（高/中/低）
5. 期限はありますか？

---

### Phase 2: planner実行

```bash
Task:planner(prompt: "以下の要件に基づいて変更計画を立ててください
- 変更内容: {回答1}
- 想定ユーザー: {回答2}
- 既存機能との関連: {回答3}
- 優先度: {回答4}
- 期限: {回答5}
")
```

**planner内部動作**:

1. **Step 0: 要件不足チェック**実行
2. **要件不足検出時**:
   - 要件不足レポート生成
   - メインAgentに返す
3. メインAgentが追加質問
4. planner再実行
5. 要件充足 → 変更計画生成

**要件不足レポート例**:

```markdown
# 📋 Requirements Validation Report

## ❌ 要件不足検出

### 不足している情報
1. **機能の目的・ビジネス価値** が不明確
2. **技術的実現可能性** の判断に必要な情報不足

### 追加で質問すべき項目
- Q1: この機能で解決したい課題は何ですか？
- Q2: 既存のどの機能に影響しますか？

## 📌 次のアクション
メインClaude Agent: 上記の質問をユーザーに行ってください。
回答取得後、再度 Task:planner を実行してください。
```

詳細: [planner.md Step 0](../.claude/agents/planner.md)

---

### Phase 3: 計画確認・承認

**メインClaude Agentが実行**:

1. plannerが生成した変更計画をユーザーに提示
2. 既存実装への影響を説明
3. ユーザーの承認を得る

---

### Phase 4: 作業再開

**再開パターン**:

#### A. 中断作業の続きから再開（計画変更なし）

```bash
# 例: Task 2/5 完了 → 要件変更（新機能追加） → Task 3 から再開
Task:impl-dev-backend(prompt: "Task 3: ...")
```

#### B. 計画変更に準拠して再開（実装計画変更あり）

```bash
# 例: Task 2/5 完了 → 要件変更（仕様変更） → Task 3 が不要に → Task 4 から再開
# planner が新しい実装順序を提示
Task:impl-dev-backend(prompt: "変更後の Task 4: ...")
```

#### C. 最初から実装し直し（大幅な設計変更）

```bash
# 例: 既存実装を破棄 → 新設計で実装開始
git checkout -b feat-redesigned-feature
Task:impl-dev-backend(prompt: "新設計の Task 1: ...")
```

---

## ベストプラクティス

### 要件変更前の確認

- [ ] 現在の作業をキリの良いところで止める
- [ ] git commit で一時保存（ブランチも考慮）
- [ ] 既存実装への影響範囲を理解する

### 要件変更後の確認

- [ ] 変更計画を十分に理解する
- [ ] 既存テストが壊れていないか確認
- [ ] ドキュメントの更新が必要か確認

---

## 関連ドキュメント

- [planner.md Step 0](../.claude/agents/planner.md) - 要件検証チェックリスト
- [Case A Workflow](../.claude/workflows/case-a-existing-project.md) - 既存プロジェクト機能拡張
- [WORKFLOW.md](./WORKFLOW.md) - 開発フロー詳細
