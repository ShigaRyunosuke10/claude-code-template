# Nissei 工数管理システム - 要件定義書

**Version**: 1.0
**Last Updated**: 2025-10-27
**Document Type**: アプリケーション機能要件定義

---

## 目次

1. [システム概要](#1-システム概要)
2. [ユーザー管理・認証](#2-ユーザー管理認証)
3. [案件管理](#3-案件管理)
4. [工数入力](#4-工数入力)
5. [請求書管理](#5-請求書管理)
6. [資料管理](#6-資料管理)
7. [注意点管理](#7-注意点管理)
8. [マスタ管理](#8-マスタ管理)
9. [工数集計・分析](#9-工数集計分析)
10. [監査ログ](#10-監査ログ)
11. [バックアップ・復旧](#11-バックアップ復旧)
12. [管理者機能](#12-管理者機能)
13. [システム設定](#13-システム設定)
14. [画面一覧](#14-画面一覧)

---

## 1. システム概要

### 1.1 目的

製造業（射出成形機等の設計・製造）における工数管理と請求処理を一元化し、プロジェクトの進捗可視化と経理業務の効率化を実現する。

### 1.2 対象ユーザー

- **一般ユーザー**: 設計者・作業者（工数入力・案件参照）
- **管理者**: マネージャー・経理担当者（全機能アクセス・システム設定）

### 1.3 主要機能

1. **案件管理**: 機番・機種・納期等の案件情報を管理
2. **工数入力**: 日次の作業時間を15分単位で記録
3. **請求書作成**: 工数を自動集計して請求書を生成
4. **資料管理**: 機種別・シリーズ別に技術資料を共有
5. **注意点管理**: 機種ごとの設計上の注意点をカテゴリ管理
6. **監査・バックアップ**: 操作履歴の記録とデータ保全

---

## 2. ユーザー管理・認証

### 2.1 ユーザー登録

#### 2.1.1 機能概要

新規ユーザーがアカウントを作成する。

#### 2.1.2 入力項目

| 項目 | 型 | 必須 | 制約 | 説明 |
|------|-----|------|------|------|
| 名前 | string | ✅ | 最大100文字 | ユーザーの表示名 |
| メールアドレス | string | ✅ | メール形式、ユニーク | ログインID |
| パスワード | string | ✅ | 最小8文字、英数字記号含む | 認証用 |
| パスワード確認 | string | ✅ | パスワードと一致 | 入力ミス防止 |

#### 2.1.3 処理フロー

1. ユーザーが登録フォームに情報を入力
2. 入力内容のバリデーション（パスワード強度、メール形式）
3. メールアドレス重複チェック
4. パスワードのハッシュ化
5. データベースに保存
6. 成功時、ログイン画面へリダイレクト

#### 2.1.4 エラーハンドリング

- **メールアドレス重複**: 「このメールアドレスは既に登録されています」
- **バリデーションエラー**: 「パスワードは8文字以上で英数字を含む必要があります」

### 2.2 ログイン

#### 2.2.1 機能概要

登録済みユーザーがシステムにログインする。

#### 2.2.2 入力項目

| 項目 | 型 | 必須 | 説明 |
|------|-----|------|------|
| メールアドレス | string | ✅ | 登録済みのメールアドレス |
| パスワード | string | ✅ | 登録時のパスワード |

#### 2.2.3 処理フロー

1. ユーザーがメールアドレスとパスワードを入力
2. バックエンドに認証リクエスト送信
3. メールアドレスで検索
4. パスワードを照合
5. 認証成功時、認証トークンを生成
6. クライアントにトークンを返却
7. クライアントはトークンを保存
8. ダッシュボードへリダイレクト

#### 2.2.4 セキュリティ要件

- **トークン有効期限**: 30分
- **ログアウト**: 保存されたトークンを削除
- **自動ログアウト**: トークン期限切れ時にログイン画面へ

#### 2.2.5 エラーハンドリング

- **認証失敗**: 「メールアドレスまたはパスワードが正しくありません」
- **アカウント無効**: 「このアカウントは無効化されています」

### 2.3 現在のユーザー情報取得

#### 2.3.1 機能概要

ログイン中のユーザー情報（名前、メール、管理者フラグ）を取得する。

#### 2.3.2 レスポンス項目

| 項目 | 型 | 説明 |
|------|-----|------|
| id | ID | ユーザーID |
| name | string | 表示名 |
| email | string | メールアドレス |
| is_admin | boolean | 管理者権限の有無 |
| is_active | boolean | アカウント有効状態 |

---

## 3. 案件管理

### 3.1 案件一覧表示

#### 3.1.1 機能概要

全案件を表形式で一覧表示し、検索・フィルタリング・ページネーションを提供する。

#### 3.1.2 表示項目

| 項目 | 型 | 説明 |
|------|-----|------|
| 管理番号 | string | 案件の一意識別子（例: E252019） |
| 機番 | string | 機械の識別番号（例: HMX7-CN2） |
| 機種 | string | 機械のモデル名（例: NEX140Ⅲ） |
| 仕様コード | string | 機種の仕様（例: 24AK） |
| フルモデル名 | string | 機種 + 仕様コード（例: NEX140Ⅲ-24AK） |
| 担当者 | string | アサインされたユーザー名 |
| 進捗 | string | 案件の進捗状況（未着手/進行中/完了） |
| 予定工数 | decimal | 見積もり工数（時間） |
| 実績工数 | decimal | 累計作業時間（自動計算） |
| 作図期限 | date | 納期 |

#### 3.1.3 検索・フィルタ機能

| フィルタ項目 | 型 | 説明 |
|-------------|-----|------|
| キーワード | string | 管理番号、機番、機種を部分一致検索 |
| 担当者 | ID | 自分の担当案件のみ表示 |
| 進捗 | string | 特定の進捗ステータスで絞り込み |
| 期限切れ | boolean | 作図期限超過案件のみ表示 |

#### 3.1.4 ページネーション

- **デフォルト表示件数**: 20件/ページ
- **選択可能**: 10件、20件、50件、100件
- **総件数表示**: 「全123件中 1-20件を表示」

#### 3.1.5 ソート機能

すべてのカラムでソート可能（昇順/降順）

### 3.2 案件作成

#### 3.2.1 機能概要

新規案件を登録する。

#### 3.2.2 入力項目

| 項目 | 型 | 必須 | 制約 | 説明 |
|------|-----|------|------|------|
| 管理番号 | string | ✅ | ユニーク、最大50文字 | 案件識別子（例: E252019） |
| 機番 | string | ✅ | 最大50文字 | 機械番号（例: HMX7-CN2） |
| 機種 | string | ✅ | マスタ選択 | シリーズ+トン数+世代（例: NEX140Ⅲ） |
| 仕様コード | string | ❌ | 最大50文字 | 例: 24AK |
| 作業区分 | ID | ✅ | マスタ選択 | 盤配/線加工等 |
| 担当者 | ID | ✅ | ユーザー選択 | アサイン先ユーザー |
| 進捗 | ID | ✅ | マスタ選択 | 未着手/進行中/完了 |
| 予定工数 | decimal | ❌ | 0.0以上 | 見積もり時間（時間単位） |
| 作図期限 | date | ❌ | - | 納期 |
| 備考 | text | ❌ | 最大500文字 | 補足情報 |

#### 3.2.3 自動設定項目

| 項目 | 説明 |
|------|------|
| フルモデル名 | 機種 + "-" + 仕様コード（例: NEX140Ⅲ-24AK） |
| 実績工数 | 0.0（初期値） |
| 作成日時 | サーバータイムスタンプ |
| 更新日時 | サーバータイムスタンプ |

#### 3.2.4 バリデーション

- **管理番号重複チェック**: データベースでユニーク制約
- **日付検証**: 作図期限は未来日のみ許可（警告のみ、エラーにはしない）

#### 3.2.5 処理フロー

1. ユーザーが案件作成フォームに入力
2. クライアント側でバリデーション
3. バックエンドに作成リクエスト送信
4. projectsテーブルに挿入
5. 成功時、案件詳細画面へリダイレクト

### 3.3 案件詳細表示

#### 3.3.1 機能概要

特定案件の詳細情報を表示する。

#### 3.3.2 表示内容

**基本情報セクション**:
- 管理番号、機番、機種、仕様コード、フルモデル名
- 作業区分、担当者、進捗、予定工数、実績工数、作図期限、備考

**工数サマリーセクション**:
- 累計工数（worklogs テーブルから自動集計）
- 工数進捗率（実績/予定 × 100%）
- 直近7日間の工数推移グラフ

**関連工数一覧**:
- この案件に紐づく worklog エントリを日付降順で表示
- 日付、担当者、作業時間、作業内容を表示

**関連資料一覧**:
- スコープに基づいて表示される資料
  - machine: この機番専用資料
  - model: この機種専用資料
  - tonnage: このトン数共通資料
  - series: このシリーズ共通資料

**関連注意点一覧**:
- この案件の機種に該当する注意点をカテゴリ別に表示

### 3.4 案件編集

#### 3.4.1 機能概要

既存案件の情報を更新する。

#### 3.4.2 編集可能項目

すべての入力項目が編集可能（管理番号はユニーク制約のため変更時に重複チェック）

#### 3.4.3 処理フロー

1. 案件詳細画面から「編集」ボタンをクリック
2. 編集フォームに現在の値がプリセット
3. ユーザーが変更を加える
4. バックエンドに更新リクエスト送信
5. projectsテーブルを更新
6. 成功時、案件詳細画面へリダイレクト

### 3.5 案件削除

#### 3.5.1 機能概要

案件をソフトデリートする（論理削除）。

#### 3.5.2 削除条件

- 管理者のみ削除可能
- 工数データが紐づいている場合は警告表示
- 削除確認ダイアログを表示（「この案件を削除しますか？」）

#### 3.5.3 処理フロー

1. 案件詳細画面から「削除」ボタンをクリック
2. 確認ダイアログ表示
3. ユーザーが「削除」を確認
4. バックエンドに削除リクエスト送信
5. projectsテーブルの`deleted_at`フィールドに現在時刻を記録
6. 成功時、案件一覧画面へリダイレクト

#### 3.5.4 ゴミ箱機能

- 削除された案件は「ゴミ箱」画面から復元可能
- 復元操作で`deleted_at`をNULLに戻す

---

## 4. 工数入力

### 4.1 工数入力画面（メイン機能）

#### 4.1.1 機能概要

スプレッドシート風の表形式で複数行の工数を一括入力する。

#### 4.1.2 表示形式

**テーブルレイアウト（横スクロール対応）**:

| 作業日 | 案件（ドロップダウン） | 作業時間（時間） | 作業内容 | 操作 |
|--------|----------------------|-----------------|---------|------|
| 2025-01-15 | NEX140Ⅲ-24AK（E252019） | 4.5 | 配線図作成 | 保存/削除 |
| 2025-01-16 | NEX200-30AF（E252020） | 2.0 | 制御盤設計 | 保存/削除 |
| （新規行） | （選択） | （入力） | （入力） | 保存 |

#### 4.1.3 入力項目

| 項目 | 型 | 必須 | 制約 | 説明 |
|------|-----|------|------|------|
| 作業日 | date | ✅ | 過去または当日 | 工数実施日 |
| 案件 | ID | ✅ | プルダウン選択 | 対象案件（管理番号+機種を表示） |
| 作業時間 | decimal | ✅ | 0.25以上（15分単位） | 実施時間（時間） |
| 作業内容 | text | ❌ | 最大500文字 | 作業詳細メモ |

#### 4.1.4 入力支援機能

**案件ドロップダウン**:
- 形式: `NEX140Ⅲ-24AK (E252019)`
- ソート: 直近で使用した案件を上位表示
- 検索: 管理番号・機番・機種でフィルタリング

**デフォルト値**:
- 作業日: 空（必須バリデーション）
- 案件: 未選択
- 作業時間: 0

**新規行追加**:
- 「+ 行を追加」ボタンで新しい入力行を追加
- 最大20行まで同時入力可能

#### 4.1.5 バリデーション

| 項目 | ルール | エラーメッセージ |
|------|--------|----------------|
| 作業日 | 必須 | 「作業日を入力してください」 |
| 案件 | 必須 | 「案件を選択してください」 |
| 作業時間 | 1分以上 | 「作業時間は1分以上を入力してください」 |
| 作業時間 | 数値 | 「作業時間は数値で入力してください」 |

#### 4.1.6 保存処理

**個別保存**:
- 各行の「保存」ボタンで1行ずつ保存
- バックエンドにリクエスト
- 成功時、Toast通知「工数を保存しました」
- 失敗時、Toast通知（エラー詳細）

**一括保存**:
- 画面下部の「すべて保存」ボタンで未保存行を一括保存
- トランザクション処理（全成功 or 全失敗）

#### 4.1.7 編集・削除

**インライン編集**:
- 保存済みの行をクリックで編集モード切り替え
- 「保存」ボタンで 更新リクエスト

**削除**:
- 「削除」ボタンで 削除リクエスト
- 確認ダイアログ表示（「この工数を削除しますか？」）

### 4.2 工数一覧表示

#### 4.2.1 機能概要

登録済み工数を一覧表示し、検索・フィルタ・編集・削除を提供する。

#### 4.2.2 表示項目

| 項目 | 型 | 説明 |
|------|-----|------|
| 作業日 | date | 工数実施日 |
| 案件 | string | 管理番号 + フルモデル名 |
| 担当者 | string | 登録ユーザー名 |
| 作業時間 | decimal | 作業時間（時間） |
| 作業内容 | text | 作業詳細 |

#### 4.2.3 フィルタリング機能

| フィルタ項目 | 型 | 説明 |
|-------------|-----|------|
| 期間 | date範囲 | 開始日〜終了日で絞り込み |
| 案件 | ID | 特定案件の工数のみ表示 |
| 担当者 | ID | 特定ユーザーの工数のみ表示 |

#### 4.2.4 ソート機能

- デフォルト: 作業日降順（最新が上）
- すべてのカラムでソート可能

#### 4.2.5 CSV出力

- 「CSV出力」ボタンで現在のフィルタ条件に基づく工数データをCSV形式でダウンロード
- 形式: BOM付きUTF-8、カンマ区切り
- ヘッダー: 作業日, 管理番号, 機種, 担当者, 作業時間, 作業内容

### 4.3 工数編集

#### 4.3.1 機能概要

登録済み工数の内容を変更する。

#### 4.3.2 編集可能項目

すべての項目が編集可能（作業日、案件、作業時間、作業内容）

#### 4.3.3 処理フロー

1. 工数一覧から「編集」ボタンをクリック
2. 編集フォームに現在の値がプリセット
3. ユーザーが変更を加える
4. バックエンドに更新リクエスト送信（更新）
5. 成功時、Toast通知「工数を更新しました」

### 4.4 工数削除

#### 4.4.1 機能概要

登録済み工数を削除する（物理削除）。

#### 4.4.2 処理フロー

1. 工数一覧から「削除」ボタンをクリック
2. 確認ダイアログ表示（「この工数を削除しますか？」）
3. ユーザーが「削除」を確認
4. バックエンドに削除リクエスト送信（削除）
5. 成功時、Toast通知「工数を削除しました」

### 4.5 キーボード操作（実装予定）

#### 4.5.1 機能概要

スプレッドシート風の高速入力を実現するキーボードショートカット。

#### 4.5.2 ショートカット一覧

| キー | 動作 |
|------|------|
| Enter | 次の行の同じカラムにフォーカス移動 |
| Tab | 右のセル（次のカラム）にフォーカス移動 |
| Shift+Tab | 左のセル（前のカラム）にフォーカス移動 |
| Ctrl+S | 現在の行を保存 |
| Ctrl+N | 新規行を追加 |

---

## 5. 請求書管理

### 5.1 請求プレビュー

#### 5.1.1 機能概要

指定月の工数を案件ごとに自動集計し、請求書プレビューを表示する。

#### 5.1.2 パラメータ

| 項目 | 型 | 必須 | 説明 |
|------|-----|------|------|
| 年 | integer | ✅ | YYYY形式（例: 2025） |
| 月 | integer | ✅ | 1〜12 |

#### 5.1.3 表示内容

**請求サマリーヘッダー**:
- 請求対象月: 2025年1月
- 合計案件数: 15件
- 合計工数: 320.5時間
- ステータス: 下書き / 確定済み

**案件別集計テーブル**:

| 管理番号 | 機番（委託業務内容） | 実工数（時間） |
|---------|-------------------|--------------|
| E252019 | HMX7-CN2 | 45.5 |
| E252020 | NEX200-30AF | 32.0 |
| ... | ... | ... |

#### 5.1.4 工数丸め設定

システム設定（settings.rounding）で指定された方法で工数を丸める:
- **切り上げ**: 45.3時間 → 46時間
- **切り捨て**: 45.8時間 → 45時間
- **四捨五入**: 45.6時間 → 46時間

#### 5.1.5 処理フロー

1. ユーザーが年月を指定
2. バックエンドにリクエスト
3. バックエンドでworklogs テーブルから該当月の工数を抽出
4. 案件ごとにグループ化して合計
5. 丸め設定を適用
6. JSON形式でレスポンス
7. フロントエンドで表形式で表示

### 5.2 請求確定

#### 5.2.1 機能概要

プレビュー内容を確定し、invoices/invoice_items テーブルに保存する。

#### 5.2.2 実行条件

- 管理者のみ実行可能
- 同じ年月の請求書が既に確定済みの場合はエラー

#### 5.2.3 処理フロー

1. プレビュー画面で「確定」ボタンをクリック
2. 確認ダイアログ表示（「この請求書を確定しますか？確定後は編集できません」）
3. ユーザーが「確定」を承認
4. バックエンドにリクエスト
5. トランザクション開始
6. invoices テーブルに請求書レコードを作成（status: closed）
7. invoice_items テーブルに案件別明細を保存
8. トランザクションコミット
9. 成功時、Toast通知「請求書を確定しました」

### 5.3 請求書一覧

#### 5.3.1 機能概要

過去に確定した請求書を一覧表示する。

#### 5.3.2 表示項目

| 項目 | 型 | 説明 |
|------|-----|------|
| 対象月 | string | YYYY年MM月 |
| 案件数 | integer | 含まれる案件の数 |
| 合計工数 | decimal | 累計時間 |
| 確定日時 | timestamp | 請求確定日時 |
| 確定者 | string | 確定したユーザー名 |
| 操作 | - | CSV出力ボタン |

#### 5.3.3 ソート機能

- デフォルト: 対象月降順（最新が上）

### 5.4 請求書CSV出力

#### 5.4.1 機能概要

確定済み請求書をCSV形式でダウンロードする。

#### 5.4.2 パラメータ

| 項目 | 型 | 必須 | 説明 |
|------|-----|------|------|
| 年 | integer | ✅ | YYYY形式 |
| 月 | integer | ✅ | 1〜12 |

#### 5.4.3 CSV形式

- **エンコーディング**: BOM付きUTF-8
- **区切り文字**: カンマ
- **ヘッダー**: 管理番号, 委託業務内容（機番）, 実工数（時間）

**出力例**:
```csv
管理番号,委託業務内容,実工数
E252019,HMX7-CN2,45.5
E252020,NEX200-30AF,32.0
```

#### 5.4.4 セキュリティ対策

**CSVインジェクション防止**:
- =, +, -, @ で始まる値を自動エスケープ
- 例: `=SUM(A1:A10)` → `'=SUM(A1:A10)`

---

## 6. 資料管理

### 6.1 資料一覧表示

#### 6.1.1 機能概要

登録された技術資料を4段階スコープ（machine/model/tonnage/series）で一覧表示する。

#### 6.1.2 表示項目

| 項目 | 型 | 説明 |
|------|-----|------|
| タイトル | string | 資料名 |
| スコープ | string | 共有範囲（machine/model/tonnage/series） |
| 対象シリーズ | string | NEX/NX/SX等 |
| 対象トン数 | integer | 140/200等 |
| 対象機番 | string | スコープがmachineの場合のみ |
| ファイル名 | string | 元ファイル名 |
| アップロード日時 | timestamp | 登録日時 |
| アップロード者 | string | 登録ユーザー名 |

#### 6.1.3 フィルタリング機能

| フィルタ項目 | 型 | 説明 |
|-------------|-----|------|
| スコープ | string | machine/model/tonnage/series |
| シリーズ | string | NEX等 |
| トン数 | integer | 140等 |
| 機番 | string | 特定機番の資料のみ表示 |

### 6.2 資料アップロード

#### 6.2.1 機能概要

技術資料（PDF、画像、Excel等）をアップロードし、スコープを指定して共有する。

#### 6.2.2 入力項目

| 項目 | 型 | 必須 | 制約 | 説明 |
|------|-----|------|------|------|
| タイトル | string | ✅ | 最大200文字 | 資料名 |
| スコープ | string | ✅ | machine/model/tonnage/series | 共有範囲 |
| シリーズ | string | ✅ | - | NEX/NX/SX等 |
| トン数 | integer | ❌ | tonnage/model/machineの場合必須 | 140/200等 |
| 機種 | string | ❌ | model/machineの場合必須 | NEX140Ⅲ等 |
| 機番 | string | ❌ | machineの場合必須 | HMX7-CN2等 |
| ファイル | file | ✅ | 最大100MB | アップロードファイル |

#### 6.2.3 スコープの階層構造

1. **series（シリーズ共通）**: NEXシリーズ全体で共有
2. **tonnage（トン数共通）**: NEX140トン機全体で共有
3. **model（機種専用）**: NEX140Ⅲ-24AK専用
4. **machine（機番専用）**: HMX7-CN2専用

#### 6.2.4 処理フロー

1. ユーザーがアップロードフォームに入力
2. ファイルをブラウザから送信
3. バックエンドでファイルをストレージにアップロード
4. メタデータを保存
5. 成功時、Toast通知「資料をアップロードしました」

### 6.3 資料ダウンロード

#### 6.3.1 機能概要

登録された資料をダウンロードする。

#### 6.3.2 処理フロー

1. 資料一覧から「ダウンロード」ボタンをクリック
2. バックエンドにダウンロードリクエスト送信
3. ストレージからファイルを取得
4. ブラウザでファイルをダウンロード

### 6.4 資料削除

#### 6.4.1 機能概要

登録された資料を削除する（管理者のみ）。

#### 6.4.2 処理フロー

1. 資料一覧から「削除」ボタンをクリック
2. 確認ダイアログ表示（「この資料を削除しますか？」）
3. ユーザーが「削除」を確認
4. バックエンドに削除リクエスト送信
5. ストレージからファイルを削除
6. materialsテーブルからレコードを削除
7. 成功時、Toast通知「資料を削除しました」

---

## 7. 注意点管理

### 7.1 注意点一覧表示

#### 7.1.1 機能概要

設計上の注意点をカテゴリ別に一覧表示する。

#### 7.1.2 表示項目

| 項目 | 型 | 説明 |
|------|-----|------|
| 連番 | integer | ユニークな識別番号 |
| カテゴリ | string | 使い方/組付/注意点等 |
| 対象シリーズ | string | NEX/NX/SX等 |
| 対象機種パターン | string | 正規表現パターン（例: NEX140.*） |
| 注意点内容 | text | 実際の注意事項 |
| 作成者 | string | 登録ユーザー名 |
| 備考 | text | 補足情報 |

#### 7.1.3 フィルタリング機能

| フィルタ項目 | 型 | 説明 |
|-------------|-----|------|
| カテゴリ | ID | 特定カテゴリで絞り込み |
| シリーズ | string | 対象シリーズで絞り込み |
| キーワード | string | 注意点内容を部分一致検索 |

### 7.2 注意点作成

#### 7.2.1 機能概要

新しい注意点を登録する（管理者のみ）。

#### 7.2.2 入力項目

| 項目 | 型 | 必須 | 制約 | 説明 |
|------|-----|------|------|------|
| 連番 | integer | ✅ | ユニーク | 識別番号 |
| カテゴリ | ID | ✅ | - | 注意点カテゴリ |
| 対象シリーズ | string | ✅ | - | NEX/NX/SX等 |
| 対象機種パターン | string | ❌ | 正規表現 | 例: NEX140.* |
| 注意点内容 | text | ✅ | 最大2000文字 | 注意事項の本文 |
| 作成者 | string | ✅ | - | 登録者名 |
| 備考 | text | ❌ | 最大500文字 | 補足情報 |

#### 7.2.3 処理フロー

1. ユーザーが作成フォームに入力
2. バックエンドに作成リクエスト送信
3. master_chuitenテーブルに保存
4. 成功時、Toast通知「注意点を登録しました」

### 7.3 注意点カテゴリ管理

#### 7.3.1 機能概要

注意点のカテゴリを追加・削除する（管理者のみ）。

#### 7.3.2 カテゴリ例

- 使い方
- 組付
- 注意点
- チェック項目
- トラブルシューティング

#### 7.3.3 処理フロー

**カテゴリ追加**:
1. カテゴリ名を入力
2. リクエスト
3. master_chuiten_categoryテーブルに保存

**カテゴリ削除**:
1. カテゴリ一覧から「削除」ボタンをクリック
2. 確認ダイアログ表示（「このカテゴリを削除しますか？」）
3. 削除リクエスト
4. 関連する注意点がある場合はエラー（外部キー制約）

### 7.4 案件関連注意点表示

#### 7.4.1 機能概要

特定案件の機種に該当する注意点を自動抽出して表示する。

#### 7.4.2 抽出ロジック

1. 案件のシリーズを取得（例: NEX）
2. 案件のフルモデル名を取得（例: NEX140Ⅲ-24AK）
3. master_chuitenテーブルから以下の条件で検索:
   - `target_series = 'NEX'`
   - `target_model_pattern` が機種名とマッチ（正規表現）
4. カテゴリ別にグループ化して表示

---

## 8. マスタ管理

### 8.1 マスタ種類

#### 8.1.1 作業区分マスタ

| フィールド | 型 | 説明 |
|-----------|-----|------|
| id | ID | 主キー |
| name | string | 区分名（盤配/線加工等） |
| display_order | integer | 表示順序 |

#### 8.1.2 機種マスタ

| フィールド | 型 | 説明 |
|-----------|-----|------|
| id | ID | 主キー |
| name | string | 機種名（NEX140Ⅲ等） |
| series | string | シリーズ（NEX） |
| tonnage | integer | トン数（140） |
| display_order | integer | 表示順序 |

#### 8.1.3 納入先マスタ

| フィールド | 型 | 説明 |
|-----------|-----|------|
| id | ID | 主キー |
| name | string | 納入先名 |
| display_order | integer | 表示順序 |

#### 8.1.4 進捗マスタ

| フィールド | 型 | 説明 |
|-----------|-----|------|
| id | ID | 主キー |
| name | string | 進捗名（未着手/進行中/完了） |
| display_order | integer | 表示順序 |

### 8.2 マスタ一覧表示

#### 8.2.1 機能概要

各マスタの登録データを一覧表示する。

#### 8.2.2 表示項目

- ID、名前、表示順序、登録日時、更新日時

#### 8.2.3 ソート機能

- デフォルト: 表示順序昇順
- すべてのカラムでソート可能

### 8.3 マスタ作成

#### 8.3.1 機能概要

新しいマスタデータを登録する（管理者のみ）。

#### 8.3.2 入力項目

| 項目 | 型 | 必須 | 説明 |
|------|-----|------|------|
| 名前 | string | ✅ | マスタ名 |
| 表示順序 | integer | ❌ | ソート順（デフォルト: 9999） |

（機種マスタの場合は追加で series, tonnage を入力）

#### 8.3.3 処理フロー

1. ユーザーが作成フォームに入力
2. バックエンドにリクエスト
3. 該当マスタテーブルに保存
4. 成功時、Toast通知「マスタを登録しました」

### 8.4 マスタ更新

#### 8.4.1 機能概要

既存マスタデータを更新する（管理者のみ）。

#### 8.4.2 処理フロー

1. マスタ一覧から「編集」ボタンをクリック
2. 編集フォームに現在の値がプリセット
3. ユーザーが変更を加える
4. バックエンドに更新リクエスト
5. 成功時、Toast通知「マスタを更新しました」

### 8.5 マスタ削除

#### 8.5.1 機能概要

マスタデータを削除する（管理者のみ）。

#### 8.5.2 削除条件

- 他のテーブルから参照されている場合はエラー（外部キー制約）
- 確認ダイアログ表示

#### 8.5.3 処理フロー

1. マスタ一覧から「削除」ボタンをクリック
2. 確認ダイアログ表示（「このマスタを削除しますか？」）
3. 削除リクエスト
4. 成功時、Toast通知「マスタを削除しました」

---

## 9. 工数集計・分析

### 9.1 日次集計

#### 9.1.1 機能概要

指定期間の日次工数を集計して表示する。

#### 9.1.2 パラメータ

| 項目 | 型 | 必須 | 説明 |
|------|-----|------|------|
| 開始日 | date | ✅ | YYYY-MM-DD形式 |
| 終了日 | date | ✅ | YYYY-MM-DD形式 |
| ユーザーID | ID | ❌ | 特定ユーザーのみ集計 |

#### 9.1.3 レスポンス形式

```json
{
  "daily_aggregations": [
    {
      "date": "2025-01-15",
      "total_hours": 45.5,
      "project_count": 10
    },
    {
      "date": "2025-01-16",
      "total_hours": 38.0,
      "project_count": 8
    }
  ]
}
```

### 9.2 月次集計

#### 9.2.1 機能概要

指定月の工数を案件ごとに集計して表示する。

#### 9.2.2 パラメータ

| 項目 | 型 | 必須 | 説明 |
|------|-----|------|------|
| 年月 | string | ✅ | YYYY-MM形式（例: 2025-01） |

#### 9.2.3 レスポンス形式

```json
{
  "year_month": "2025-01",
  "project_aggregations": [
    {
      "project_id": "uuid",
      "management_no": "E252019",
      "full_model_name": "NEX140Ⅲ-24AK",
      "total_hours": 45.5,
      "worklog_count": 12
    }
  ],
  "total_hours": 320.5
}
```

### 9.3 推移データ取得

#### 9.3.1 機能概要

過去6ヶ月の案件数推移をグラフ表示用に取得する。

#### 9.3.2 レスポンス形式

```json
{
  "trend_data": [
    {
      "month": "2024-08",
      "active_projects": 15,
      "completed_projects": 5
    },
    {
      "month": "2024-09",
      "active_projects": 18,
      "completed_projects": 7
    }
  ]
}
```

### 9.4 CSV出力

#### 9.4.1 機能概要

指定月の工数集計をCSV形式でダウンロードする。

#### 9.4.2 CSV形式

- **ヘッダー**: 管理番号, 機番, 実工数（時間）
- **エンコーディング**: BOM付きUTF-8
- **セキュリティ**: CSVインジェクション対策実装済み

---

## 10. 監査ログ

### 10.1 監査ログ一覧表示

#### 10.1.1 機能概要

全ユーザーの操作履歴を一覧表示する（管理者のみ）。

#### 10.1.2 表示項目

| 項目 | 型 | 説明 |
|------|-----|------|
| 日時 | timestamp | 操作日時（UTC） |
| ユーザー名 | string | 操作したユーザー |
| メールアドレス | string | ユーザーのメール |
| 操作 | string | CREATE/UPDATE/DELETE/LOGIN/LOGOUT |
| 対象 | string | projects/worklogs/invoices等 |
| エンティティID | ID | 対象レコードのID |
| IPアドレス | string | クライアントIP（IPv4/IPv6） |
| ユーザーエージェント | string | ブラウザ情報 |

#### 10.1.3 フィルタリング機能

| フィルタ項目 | 型 | 説明 |
|-------------|-----|------|
| ユーザーID | ID | 特定ユーザーのログのみ表示 |
| 操作種別 | string | CREATE/UPDATE/DELETE/LOGIN/LOGOUT |
| 対象エンティティ | string | projects/worklogs/invoices等 |
| 期間 | date範囲 | 開始日〜終了日 |

#### 10.1.4 ページネーション

- **デフォルト表示件数**: 50件/ページ
- **最大件数**: 100件/ページ

### 10.2 監査ログ詳細表示

#### 10.2.1 機能概要

特定ログの詳細情報を表示する（管理者のみ）。

#### 10.2.2 表示内容

**基本情報**:
- ログID、ユーザー名、操作種別、対象エンティティ、日時

**変更内容**（UPDATE操作の場合）:
- **変更前**: old_value（JSON形式）
- **変更後**: new_value（JSON形式）
- **差分表示**: 変更されたフィールドをハイライト

### 10.3 監査ログCSV出力

#### 10.3.1 機能概要

監査ログをCSV形式でダウンロードする（管理者のみ）。

#### 10.3.2 CSV形式

- **ヘッダー**: 日時, ユーザー名, メールアドレス, 操作, 対象, エンティティID, IPアドレス, ユーザーエージェント
- **エンコーディング**: BOM付きUTF-8
- **日時形式**: UTC（ISO 8601形式）

### 10.4 自動記録対象

#### 10.4.1 記録対象操作

- 案件管理（作成/更新/削除）
- 工数入力（作成/更新/削除）
- 請求書（作成/確定）
- 資料管理（アップロード/削除）
- 注意点管理（作成/更新/削除）
- マスタ管理（作成/更新/削除）
- 管理者機能（ユーザー有効化/無効化/削除）
- ログイン/ログアウト

#### 10.4.2 記録除外対象

- （ユーザー情報取得）
- （集計API）
- CORSプリフライトリクエスト（OPTIONS）

---

## 11. バックアップ・復旧

### 11.1 バックアップ作成

#### 11.1.1 機能概要

データベースの全体または一部をJSON形式でバックアップする（管理者のみ）。

#### 11.1.2 入力項目

| 項目 | 型 | 必須 | 制約 | 説明 |
|------|-----|------|------|------|
| バックアップ名 | string | ✅ | 最大200文字 | 識別用名称 |
| 説明 | text | ❌ | 最大500文字 | 用途や目的 |
| バックアップ種別 | string | ✅ | full/partial | 全体/部分 |
| 対象テーブル | array | ❌ | partial時必須 | 選択テーブル一覧 |

#### 11.1.3 対応テーブル（14テーブル）

- users
- projects
- worklogs
- invoices, invoice_items
- materials
- master_chuiten, master_chuiten_category
- master_work_category, master_kishyu, master_nounyusaki, master_shinchoku
- system_settings
- audit_logs

#### 11.1.4 バックアップ形式

- **ファイル形式**: JSON
- **ストレージ**: ローカルファイルシステム（`backend/backups/`）
- **ファイル名形式**: `backup_YYYYMMDD_HHMMSS_full.json`
- **サイズ制限**: 500MB

#### 11.1.5 処理フロー

1. ユーザーがバックアップ作成フォームに入力
2. バックエンドにリクエスト
3. 対象テーブルのデータを抽出
4. JSON形式でファイル保存
5. backupsテーブルにメタデータを保存
6. 成功時、Toast通知「バックアップを作成しました」

### 11.2 バックアップ一覧表示

#### 11.2.1 機能概要

作成済みバックアップを一覧表示する（管理者のみ）。

#### 11.2.2 表示項目

| 項目 | 型 | 説明 |
|------|-----|------|
| バックアップ名 | string | 識別用名称 |
| 説明 | text | 用途や目的 |
| 種別 | string | 全体/部分 |
| 対象テーブル | array | 含まれるテーブル一覧 |
| ファイルサイズ | integer | バイト単位 |
| ステータス | string | completed/failed/in_progress |
| 作成日時 | timestamp | バックアップ実行日時 |
| 作成者 | string | バックアップ実行ユーザー名 |
| 復旧日時 | timestamp | 復旧実行日時（未実行ならNULL） |
| 復旧者 | string | 復旧実行ユーザー名 |

#### 11.2.3 ソート機能

- デフォルト: 作成日時降順（最新が上）

### 11.3 データ復旧

#### 11.3.1 機能概要

バックアップファイルからデータを復元する（管理者のみ）。

#### 11.3.2 パラメータ

| 項目 | 型 | 必須 | 説明 |
|------|-----|------|------|
| バックアップID | ID | ✅ | 復旧元バックアップ |
| 復旧対象テーブル | array | ❌ | 未指定で全テーブル復旧 |

#### 11.3.3 処理フロー

1. バックアップ一覧から「復旧」ボタンをクリック
2. 確認ダイアログ表示（「このバックアップからデータを復旧しますか？既存データは上書きされます」）
3. ユーザーが「復旧」を確認
4. バックエンドにリクエスト
5. トランザクション開始
6. 対象テーブルのデータを削除
7. バックアップファイルからデータを復元
8. トランザクションコミット
9. 成功時、Toast通知「データを復旧しました」

#### 11.3.4 復旧オプション

- **全体復旧**: すべてのテーブルを復元
- **部分復旧**: 指定テーブルのみ復元

### 11.4 バックアップ削除

#### 11.4.1 機能概要

バックアップファイルとメタデータを削除する（管理者のみ）。

#### 11.4.2 処理フロー

1. バックアップ一覧から「削除」ボタンをクリック
2. 確認ダイアログ表示（「このバックアップを削除しますか？」）
3. 削除リクエスト
4. ファイルシステムからファイル削除
5. backupsテーブルからレコード削除
6. 成功時、Toast通知「バックアップを削除しました」

### 11.5 セキュリティ対策

#### 11.5.1 パストラバーサル対策

- バックアップファイルパスを`validate_backup_path`関数で検証
- `backend/backups/`ディレクトリ外へのアクセスを拒否

#### 11.5.2 アクセス制御

- すべてのバックアップAPI操作は管理者のみ実行可能
- `is_admin=true`のチェックをミドルウェアで実施

---

## 12. 管理者機能

### 12.1 全ユーザー一覧

#### 12.1.1 機能概要

システムに登録された全ユーザーを一覧表示する（管理者のみ）。

#### 12.1.2 表示項目

| 項目 | 型 | 説明 |
|------|-----|------|
| ユーザー名 | string | 表示名 |
| メールアドレス | string | ログインID |
| 管理者権限 | boolean | is_admin（True/False） |
| アカウント状態 | boolean | is_active（有効/無効） |
| 登録日時 | timestamp | アカウント作成日時 |
| 最終ログイン | timestamp | 最後にログインした日時 |

#### 12.1.3 フィルタリング機能

| フィルタ項目 | 型 | 説明 |
|-------------|-----|------|
| アカウント状態 | boolean | 有効/無効で絞り込み |
| 管理者権限 | boolean | 管理者のみ表示 |

### 12.2 ユーザー有効化

#### 12.2.1 機能概要

無効化されたユーザーを再度有効にする（管理者のみ）。

#### 12.2.2 処理フロー

1. ユーザー一覧から「有効化」ボタンをクリック
2. 有効化 リクエスト
3. usersテーブルの`is_active`をTrueに更新
4. 成功時、Toast通知「ユーザーを有効化しました」

### 12.3 ユーザー無効化

#### 12.3.1 機能概要

ユーザーのログインを無効にする（管理者のみ）。

#### 12.3.2 処理フロー

1. ユーザー一覧から「無効化」ボタンをクリック
2. 確認ダイアログ表示（「このユーザーを無効化しますか？」）
3. 無効化 リクエスト
4. usersテーブルの`is_active`をFalseに更新
5. 成功時、Toast通知「ユーザーを無効化しました」

#### 12.3.3 無効化の影響

- ログイン不可（既存セッションも無効）
- API呼び出しは認証エラー
- 過去のデータは保持（工数記録等）

### 12.4 ユーザー削除

#### 12.4.1 機能概要

ユーザーアカウントを完全に削除する（管理者のみ）。

#### 12.4.2 削除条件

- 工数データ等が紐づいている場合は削除不可（外部キー制約）
- 確認ダイアログ表示

#### 12.4.3 処理フロー

1. ユーザー一覧から「削除」ボタンをクリック
2. 確認ダイアログ表示（「このユーザーを削除しますか？関連データがある場合は削除できません」）
3. 削除リクエスト
4. usersテーブルからレコード削除
5. 成功時、Toast通知「ユーザーを削除しました」

---

## 13. システム設定

### 13.1 工数の丸め設定

#### 13.1.1 機能概要

請求書作成時の工数丸め方法を設定する（管理者のみ）。

#### 13.1.2 設定項目

| 項目 | 型 | 選択肢 | 説明 |
|------|-----|--------|------|
| 丸め方法 | string | up/down/round | 切り上げ/切り捨て/四捨五入 |
| 丸め単位 | decimal | 1.0, 0.5, 0.25 | 1時間/30分/15分単位 |

#### 13.1.3 例

**切り上げ（up）、1時間単位**:
- 45.3時間 → 46時間
- 45.0時間 → 45時間

**切り捨て（down）、1時間単位**:
- 45.8時間 → 45時間

**四捨五入（round）、1時間単位**:
- 45.4時間 → 45時間
- 45.6時間 → 46時間

#### 13.1.4 処理フロー

1. 設定画面で丸め方法と単位を選択
2. バックエンドに更新リクエスト
3. system_settingsテーブルを更新
   - `rounding_method`: up/down/round
   - `rounding_unit`: 1.0/0.5/0.25
4. 成功時、Toast通知「設定を更新しました」

---

## 14. 画面一覧

### 14.1 認証画面

| 画面名 | パス | 説明 |
|--------|------|------|
| ログイン | /login | ユーザー認証 |
| 登録 | /register | 新規アカウント作成 |

### 14.2 ダッシュボード

| 画面名 | パス | 説明 |
|--------|------|------|
| ダッシュボード | /dashboard | 工数サマリー・案件推移グラフ |

### 14.3 案件管理

| 画面名 | パス | 説明 |
|--------|------|------|
| 案件一覧 | /projects | 案件一覧・検索 |
| 案件詳細 | /projects/[id] | 案件情報・関連工数・資料・注意点 |
| 案件作成 | /projects/new | 新規案件登録 |
| 案件編集 | /projects/[id]/edit | 案件情報編集 |
| ゴミ箱 | /projects/trash | 削除済み案件一覧・復元 |

### 14.4 工数管理

| 画面名 | パス | 説明 |
|--------|------|------|
| 工数入力 | /worklogs | スプレッドシート風工数入力 |
| 工数編集 | /worklogs/[id]/edit | 個別工数編集 |

### 14.5 請求管理

| 画面名 | パス | 説明 |
|--------|------|------|
| 請求書一覧 | /invoices | 月別請求書一覧・プレビュー・確定 |

### 14.6 資料管理

| 画面名 | パス | 説明 |
|--------|------|------|
| 資料一覧 | /materials | スコープ別資料一覧・アップロード |

### 14.7 注意点管理

| 画面名 | パス | 説明 |
|--------|------|------|
| 注意点一覧 | /chuiten | カテゴリ別注意点一覧・作成 |

### 14.8 マスタ管理

| 画面名 | パス | 説明 |
|--------|------|------|
| マスタ管理トップ | /masters | マスタ種別選択 |
| 作業区分マスタ | /masters/sagyou-kubun | 作業区分一覧・編集 |
| 機種マスタ | /masters/machine-series | 機種一覧・編集 |
| 進捗マスタ | /masters/shinchoku | 進捗一覧・編集 |
| 問い合わせマスタ | /masters/toiawase | 問い合わせ種別一覧・編集 |

### 14.9 集計・分析

| 画面名 | パス | 説明 |
|--------|------|------|
| 工数集計 | /aggregations | 日次/月次集計・CSV出力 |

### 14.10 システム設定

| 画面名 | パス | 説明 |
|--------|------|------|
| 丸め設定 | /settings/rounding | 工数丸め方法設定 |

### 14.11 管理者機能

| 画面名 | パス | 説明 |
|--------|------|------|
| 管理者パネル | /admin-panel-secret | ユーザー管理トップ |
| 監査ログ一覧 | /audit-logs | 操作履歴一覧・フィルタ・CSV出力 |
| バックアップ一覧 | /backups | バックアップ作成・復旧・削除 |

---

## 付録A: 用語集

| 用語 | 説明 |
|------|------|
| 案件 | 製造プロジェクト（機番・機種・納期を持つ） |
| 管理番号 | 案件の一意識別子（例: E252019） |
| 機番 | 機械の識別番号（例: HMX7-CN2） |
| 機種 | 機械のモデル名（シリーズ+トン数+世代） |
| 仕様コード | 機種の仕様（例: 24AK） |
| フルモデル名 | 機種+仕様コード（例: NEX140Ⅲ-24AK） |
| 工数 | 作業時間（分単位で記録、時間単位で表示） |
| 請求確定 | 月次請求書を確定し、編集不可にする操作 |
| スコープ | 資料の共有範囲（機番単位/機種単位/トン数単位/シリーズ単位） |
| 注意点 | 設計上の注意事項（機種・カテゴリで分類） |
| 監査ログ | ユーザー操作履歴（作成/更新/削除/ログイン） |
| バックアップ | システムデータの全体または一部を保存 |
| 丸め設定 | 請求書作成時の工数丸め方法（切り上げ/切り捨て/四捨五入） |

---

## 付録C: 改訂履歴

| バージョン | 日付 | 変更内容 | 作成者 |
|-----------|------|---------|--------|
| 1.0 | 2025-10-27 | 初版作成 | Claude Code |

---

**本ドキュメントに関する問い合わせ**:
GitHub: [ShigaRyunosuke10/nissei](https://github.com/ShigaRyunosuke10/nissei)
