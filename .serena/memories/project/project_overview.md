# Nissei 工数管理システム - プロジェクト概要

**Version**: 1.0  
**Last Updated**: 2025-10-27  
**Project Status**: Phase 0.1 - 要件定義書分析完了

---

## 1. プロジェクト基本情報

### 1.1 プロジェクト名
Nissei 工数管理システム

### 1.2 目的
製造業（射出成形機等の設計・製造）における工数管理と請求処理を一元化し、プロジェクトの進捗可視化と経理業務の効率化を実現する。

### 1.3 対象ユーザー
- **一般ユーザー**: 設計者・作業者（工数入力・案件参照）
- **管理者**: マネージャー・経理担当者（全機能アクセス・システム設定）

### 1.4 主要機能
1. **案件管理**: 機番・機種・納期等の案件情報を管理
2. **工数入力**: 日次の作業時間を15分単位で記録
3. **請求書作成**: 工数を自動集計して請求書を生成
4. **資料管理**: 機種別・シリーズ別に技術資料を共有
5. **注意点管理**: 機種ごとの設計上の注意点をカテゴリ管理
6. **監査・バックアップ**: 操作履歴の記録とデータ保全

---

## 2. ドメイン概念

### 2.1 用語集

| 用語 | 説明 |
|------|------|
| 案件 | 製造プロジェクト（機番・機種・納期を持つ） |
| 管理番号 | 案件の一意識別子（例: E252019） |
| 機番 | 機械の識別番号（例: HMX7-CN2） |
| 機種 | 機械のモデル名（シリーズ+トン数+世代） |
| 仕様コード | 機種の仕様（例: 24AK） |
| フルモデル名 | 機種+仕様コード（例: NEX140Ⅲ-24AK） |
| 工数 | 作業時間（分単位で記録、時間単位で表示） |
| 請求確定 | 月次請求書を確定し、編集不可にする操作 |
| スコープ | 資料の共有範囲（machine/model/tonnage/series） |
| 注意点 | 設計上の注意事項（機種・カテゴリで分類） |
| 監査ログ | ユーザー操作履歴（作成/更新/削除/ログイン） |
| バックアップ | システムデータの全体または一部を保存 |
| 丸め設定 | 請求書作成時の工数丸め方法（切り上げ/切り捨て/四捨五入） |

### 2.2 業務フロー概要

1. **案件登録**: 管理者または担当者が新規案件を登録（管理番号、機番、機種、納期等）
2. **工数入力**: 作業者が日次で作業時間を記録（案件・日付・時間・内容）
3. **進捗管理**: 案件詳細画面で予定工数と実績工数を比較、進捗率を可視化
4. **請求書作成**: 月末に管理者が工数を自動集計し、請求書プレビューを確認後、確定
5. **資料共有**: シリーズ・トン数・機種・機番の4段階スコープで技術資料を共有
6. **注意点参照**: 案件詳細画面で該当機種の設計注意点を自動表示
7. **監査・バックアップ**: 管理者が操作履歴を確認、定期バックアップを実施

---

## 3. 機能カテゴリ構成

### 3.1 認証・ユーザー管理
- ユーザー登録（メール・パスワード認証）
- ログイン/ログアウト
- 現在のユーザー情報取得
- 管理者権限管理

### 3.2 案件管理
- 案件一覧表示（検索・フィルタ・ページネーション）
- 案件作成・編集・削除（論理削除）
- 案件詳細表示（工数サマリー・関連資料・注意点含む）
- ゴミ箱機能（削除案件の復元）

### 3.3 工数管理
- スプレッドシート風工数入力（複数行一括入力）
- 工数一覧表示（フィルタ・ソート）
- 工数編集・削除
- CSV出力

### 3.4 請求管理
- 請求プレビュー（月次工数集計）
- 請求確定（invoices/invoice_itemsテーブルに保存）
- 請求書一覧
- 請求書CSV出力

### 3.5 資料管理
- 資料一覧表示（スコープ別フィルタ）
- 資料アップロード（PDF/画像/Excel等、最大100MB）
- 資料ダウンロード
- 資料削除（管理者のみ）

### 3.6 注意点管理
- 注意点一覧表示（カテゴリ別フィルタ）
- 注意点作成（管理者のみ）
- 注意点カテゴリ管理
- 案件関連注意点自動抽出

### 3.7 マスタ管理
- 作業区分マスタ
- 機種マスタ（シリーズ・トン数含む）
- 納入先マスタ
- 進捗マスタ
- 注意点カテゴリマスタ

### 3.8 集計・分析
- 日次集計（期間指定）
- 月次集計（案件別）
- 推移データ取得（過去6ヶ月）
- CSV出力

### 3.9 監査ログ
- 監査ログ一覧表示（管理者のみ）
- 監査ログ詳細表示（変更前後比較）
- 監査ログCSV出力
- 自動記録対象操作（案件/工数/請求書/資料/注意点/マスタ/管理者操作/ログイン等）

### 3.10 バックアップ・復旧
- バックアップ作成（全体/部分）
- バックアップ一覧表示
- データ復旧（全体/部分）
- バックアップ削除

### 3.11 管理者機能
- 全ユーザー一覧
- ユーザー有効化/無効化
- ユーザー削除

### 3.12 システム設定
- 工数の丸め設定（切り上げ/切り捨て/四捨五入、1時間/30分/15分単位）

---

## 4. 技術スタック（Phase 0.2で決定予定）

### 4.1 バックエンド
- **言語・フレームワーク**: 未定（Python/FastAPI、Node.js/Express等を検討）
- **データベース**: 未定（PostgreSQL/MySQL等を検討）
- **認証**: 未定（JWT/OAuth等を検討）

### 4.2 フロントエンド
- **フレームワーク**: 未定（React/Next.js/Vue等を検討）
- **UI**: 未定（Tailwind CSS/Material-UI等を検討）

### 4.3 インフラ
- **ホスティング**: 未定（Vercel/Render/Railway等を検討）
- **ストレージ**: 未定（ローカルファイルシステム/S3/Supabase Storage等を検討）

---

## 5. 画面構成

### 5.1 認証画面
- `/login` - ログイン
- `/register` - ユーザー登録

### 5.2 ダッシュボード
- `/dashboard` - 工数サマリー・案件推移グラフ

### 5.3 案件管理
- `/projects` - 案件一覧
- `/projects/[id]` - 案件詳細
- `/projects/new` - 案件作成
- `/projects/[id]/edit` - 案件編集
- `/projects/trash` - ゴミ箱

### 5.4 工数管理
- `/worklogs` - 工数入力（スプレッドシート風）
- `/worklogs/[id]/edit` - 工数編集

### 5.5 請求管理
- `/invoices` - 請求書一覧・プレビュー・確定

### 5.6 資料管理
- `/materials` - 資料一覧・アップロード

### 5.7 注意点管理
- `/chuiten` - 注意点一覧・作成

### 5.8 マスタ管理
- `/masters` - マスタ管理トップ
- `/masters/sagyou-kubun` - 作業区分マスタ
- `/masters/machine-series` - 機種マスタ
- `/masters/shinchoku` - 進捗マスタ
- `/masters/toiawase` - 問い合わせマスタ

### 5.9 集計・分析
- `/aggregations` - 工数集計・CSV出力

### 5.10 システム設定
- `/settings/rounding` - 丸め設定

### 5.11 管理者機能
- `/admin-panel-secret` - 管理者パネル
- `/audit-logs` - 監査ログ一覧
- `/backups` - バックアップ一覧

---

## 6. セキュリティ要件

### 6.1 認証・認可
- **トークン有効期限**: 30分
- **自動ログアウト**: トークン期限切れ時にログイン画面へリダイレクト
- **管理者権限**: 特定操作は`is_admin=true`のユーザーのみ実行可能

### 6.2 データ保護
- **パスワード**: ハッシュ化（bcrypt等）
- **CSVインジェクション対策**: `=`, `+`, `-`, `@`で始まる値を自動エスケープ
- **パストラバーサル対策**: バックアップファイルパスを検証

### 6.3 監査
- **操作履歴**: 全CRUD操作、ログイン/ログアウトを記録
- **IPアドレス・ユーザーエージェント**: 監査ログに記録

---

## 7. 非機能要件

### 7.1 パフォーマンス
- **ページネーション**: デフォルト20件/ページ、最大100件/ページ
- **ファイルサイズ制限**: アップロード最大100MB、バックアップ最大500MB

### 7.2 ユーザビリティ
- **スプレッドシート風UI**: 工数入力画面で複数行一括入力可能（最大20行）
- **キーボード操作**: Enter/Tab/Shift+Tab/Ctrl+S/Ctrl+Nのショートカット（実装予定）

### 7.3 保守性
- **論理削除**: 案件はソフトデリート（`deleted_at`フィールド）
- **ゴミ箱機能**: 削除案件を復元可能

---

## 8. 今後の開発フロー

### 8.1 Phase 0: プロジェクト基盤構築
- Phase 0.0: GitHubリポジトリ初期化（完了）
- **Phase 0.1: 要件定義書分析・Serenaメモリ初期化（現在）**
- Phase 0.2: 技術スタック決定
- Phase 0.3: 環境変数・MCP設定チェック

### 8.2 Phase 1以降: 段階的開発
- Phase 1: バックエンド基盤（DB設計・認証・API基盤）
- Phase 2: フロントエンド基盤（UI/UX・共通コンポーネント）
- Phase 3-13: 各機能の実装（案件管理→工数管理→請求書管理→...）

---

## 9. 参照資料

- **要件定義書**: `docs/references/要件定義書.md`
- **API仕様**: `.serena/memories/specifications/api_contracts.md`
- **DBスキーマ**: `.serena/memories/specifications/database_schema.md`
- **要件サマリー**: `.serena/memories/project/requirements_summary.md`
- **Phase階層**: `.serena/memories/project/phase_hierarchy.md`
