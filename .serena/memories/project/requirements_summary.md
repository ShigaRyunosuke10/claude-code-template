# Nissei 工数管理システム - 要件サマリー

**Version**: 1.0  
**Last Updated**: 2025-10-27  
**Source**: docs/references/要件定義書.md

---

## 1. システム概要

製造業（射出成形機等）における工数管理と請求処理を一元化。プロジェクトの進捗可視化と経理業務の効率化を実現。

---

## 2. ユーザー管理・認証

### 2.1 ユーザー登録
- **入力項目**: 名前、メールアドレス、パスワード、パスワード確認
- **バリデーション**: パスワード8文字以上・英数字含む、メール形式チェック、メール重複チェック
- **処理**: パスワードのハッシュ化、DBに保存、成功時ログイン画面へリダイレクト

### 2.2 ログイン
- **入力項目**: メールアドレス、パスワード
- **セキュリティ**: 認証トークン生成、トークン有効期限30分、自動ログアウト
- **処理**: メールアドレスで検索、パスワード照合、トークン返却、ダッシュボードへリダイレクト

### 2.3 現在のユーザー情報取得
- **レスポンス**: id, name, email, is_admin, is_active

---

## 3. 案件管理

### 3.1 案件一覧表示
- **表示項目**: 管理番号、機番、機種、仕様コード、フルモデル名、担当者、進捗、予定工数、実績工数、作図期限
- **検索・フィルタ**: キーワード検索（管理番号・機番・機種）、担当者フィルタ、進捗フィルタ、期限切れフィルタ
- **ページネーション**: デフォルト20件/ページ、選択可能（10/20/50/100件）
- **ソート**: 全カラムでソート可能（昇順/降順）

### 3.2 案件作成
- **入力項目**: 管理番号（必須・ユニーク）、機番（必須）、機種（必須・マスタ選択）、仕様コード、作業区分（必須・マスタ選択）、担当者（必須）、進捗（必須・マスタ選択）、予定工数、作図期限、備考
- **自動設定**: フルモデル名（機種+仕様コード）、実績工数（0.0）、作成日時、更新日時
- **バリデーション**: 管理番号重複チェック、日付検証（未来日のみ許可、警告のみ）

### 3.3 案件詳細表示
- **基本情報**: 管理番号、機番、機種、仕様コード、フルモデル名、作業区分、担当者、進捗、予定工数、実績工数、作図期限、備考
- **工数サマリー**: 累計工数（自動集計）、工数進捗率（実績/予定×100%）、直近7日間の工数推移グラフ
- **関連工数一覧**: この案件に紐づくworklogエントリを日付降順で表示
- **関連資料一覧**: スコープ（machine/model/tonnage/series）に基づいて資料を表示
- **関連注意点一覧**: 該当機種の注意点をカテゴリ別に表示

### 3.4 案件編集
- **編集可能項目**: 全入力項目（管理番号変更時は重複チェック）

### 3.5 案件削除
- **削除方式**: ソフトデリート（論理削除、`deleted_at`フィールドに記録）
- **削除条件**: 管理者のみ削除可能、工数データ紐付き時は警告表示、削除確認ダイアログ
- **ゴミ箱機能**: 削除案件を復元可能

---

## 4. 工数入力

### 4.1 工数入力画面（メイン機能）
- **表示形式**: スプレッドシート風の表形式、横スクロール対応
- **入力項目**: 作業日（必須・過去または当日）、案件（必須・ドロップダウン）、作業時間（必須・0.25時間以上/15分単位）、作業内容
- **入力支援**: 案件ドロップダウン（直近使用案件を上位表示、検索可能）、新規行追加（最大20行同時入力）
- **バリデーション**: 作業日必須、案件必須、作業時間1分以上・数値
- **保存処理**: 個別保存（1行ずつ）、一括保存（未保存行をトランザクション処理）

### 4.2 工数一覧表示
- **表示項目**: 作業日、案件（管理番号+フルモデル名）、担当者、作業時間、作業内容
- **フィルタリング**: 期間（開始日〜終了日）、案件、担当者
- **ソート**: デフォルト作業日降順、全カラムソート可能
- **CSV出力**: BOM付きUTF-8、カンマ区切り、ヘッダー付き

### 4.3 工数編集
- **編集可能項目**: 全項目（作業日、案件、作業時間、作業内容）

### 4.4 工数削除
- **削除方式**: 物理削除
- **処理**: 削除確認ダイアログ、成功時Toast通知

### 4.5 キーボード操作（実装予定）
- **ショートカット**: Enter（次行同カラム）、Tab（右セル）、Shift+Tab（左セル）、Ctrl+S（保存）、Ctrl+N（新規行）

---

## 5. 請求書管理

### 5.1 請求プレビュー
- **パラメータ**: 年（YYYY）、月（1〜12）
- **表示内容**: 請求対象月、合計案件数、合計工数、ステータス（下書き/確定済み）、案件別集計テーブル（管理番号、機番、実工数）
- **工数丸め**: システム設定（rounding）で指定（切り上げ/切り捨て/四捨五入）

### 5.2 請求確定
- **実行条件**: 管理者のみ、同じ年月の請求書が既に確定済みの場合はエラー
- **処理**: トランザクション開始、invoicesテーブルに請求書作成（status: closed）、invoice_itemsテーブルに案件別明細保存、トランザクションコミット

### 5.3 請求書一覧
- **表示項目**: 対象月（YYYY年MM月）、案件数、合計工数、確定日時、確定者、操作（CSV出力）
- **ソート**: デフォルト対象月降順

### 5.4 請求書CSV出力
- **パラメータ**: 年（YYYY）、月（1〜12）
- **CSV形式**: BOM付きUTF-8、カンマ区切り、ヘッダー（管理番号、委託業務内容、実工数）
- **セキュリティ**: CSVインジェクション防止（`=`, `+`, `-`, `@`で始まる値を自動エスケープ）

---

## 6. 資料管理

### 6.1 資料一覧表示
- **表示項目**: タイトル、スコープ（machine/model/tonnage/series）、対象シリーズ、対象トン数、対象機番、ファイル名、アップロード日時、アップロード者
- **フィルタリング**: スコープ、シリーズ、トン数、機番

### 6.2 資料アップロード
- **入力項目**: タイトル（必須）、スコープ（必須）、シリーズ（必須）、トン数（条件付き必須）、機種（条件付き必須）、機番（条件付き必須）、ファイル（必須・最大100MB）
- **スコープ階層**: series（シリーズ共通） → tonnage（トン数共通） → model（機種専用） → machine（機番専用）
- **処理**: ファイルをストレージにアップロード、メタデータをmaterialsテーブルに保存

### 6.3 資料ダウンロード
- **処理**: ストレージからファイル取得、ブラウザでダウンロード

### 6.4 資料削除
- **削除条件**: 管理者のみ
- **処理**: 削除確認ダイアログ、ストレージからファイル削除、materialsテーブルからレコード削除

---

## 7. 注意点管理

### 7.1 注意点一覧表示
- **表示項目**: 連番、カテゴリ、対象シリーズ、対象機種パターン（正規表現）、注意点内容、作成者、備考
- **フィルタリング**: カテゴリ、シリーズ、キーワード（注意点内容を部分一致検索）

### 7.2 注意点作成
- **入力項目**: 連番（必須・ユニーク）、カテゴリ（必須）、対象シリーズ（必須）、対象機種パターン（正規表現）、注意点内容（必須）、作成者（必須）、備考
- **実行条件**: 管理者のみ

### 7.3 注意点カテゴリ管理
- **カテゴリ例**: 使い方、組付、注意点、チェック項目、トラブルシューティング
- **処理**: カテゴリ追加（master_chuiten_categoryテーブルに保存）、カテゴリ削除（関連注意点がある場合はエラー）

### 7.4 案件関連注意点表示
- **抽出ロジック**: 案件のシリーズを取得、案件のフルモデル名を取得、master_chuitenテーブルから条件検索（`target_series`一致、`target_model_pattern`が機種名とマッチ）、カテゴリ別にグループ化

---

## 8. マスタ管理

### 8.1 マスタ種類
- **作業区分マスタ**: id, name（盤配/線加工等）, display_order
- **機種マスタ**: id, name（NEX140Ⅲ等）, series（NEX）, tonnage（140）, display_order
- **納入先マスタ**: id, name, display_order
- **進捗マスタ**: id, name（未着手/進行中/完了）, display_order

### 8.2 マスタ一覧表示
- **表示項目**: ID、名前、表示順序、登録日時、更新日時
- **ソート**: デフォルト表示順序昇順、全カラムソート可能

### 8.3 マスタ作成
- **入力項目**: 名前（必須）、表示順序（デフォルト9999）、（機種マスタの場合）series・tonnage
- **実行条件**: 管理者のみ

### 8.4 マスタ更新
- **編集可能項目**: 全入力項目
- **実行条件**: 管理者のみ

### 8.5 マスタ削除
- **削除条件**: 管理者のみ、他テーブルから参照されている場合はエラー（外部キー制約）
- **処理**: 削除確認ダイアログ

---

## 9. 工数集計・分析

### 9.1 日次集計
- **パラメータ**: 開始日（YYYY-MM-DD）、終了日（YYYY-MM-DD）、ユーザーID（任意）
- **レスポンス**: daily_aggregations（date, total_hours, project_count）

### 9.2 月次集計
- **パラメータ**: 年月（YYYY-MM）
- **レスポンス**: year_month, project_aggregations（project_id, management_no, full_model_name, total_hours, worklog_count）, total_hours

### 9.3 推移データ取得
- **機能**: 過去6ヶ月の案件数推移をグラフ表示用に取得
- **レスポンス**: trend_data（month, active_projects, completed_projects）

### 9.4 CSV出力
- **CSV形式**: ヘッダー（管理番号、機番、実工数）、BOM付きUTF-8、CSVインジェクション対策実装済み

---

## 10. 監査ログ

### 10.1 監査ログ一覧表示
- **表示項目**: 日時（UTC）、ユーザー名、メールアドレス、操作（CREATE/UPDATE/DELETE/LOGIN/LOGOUT）、対象（projects/worklogs/invoices等）、エンティティID、IPアドレス、ユーザーエージェント
- **フィルタリング**: ユーザーID、操作種別、対象エンティティ、期間（開始日〜終了日）
- **ページネーション**: デフォルト50件/ページ、最大100件/ページ
- **実行条件**: 管理者のみ

### 10.2 監査ログ詳細表示
- **表示内容**: ログID、ユーザー名、操作種別、対象エンティティ、日時、変更内容（UPDATE操作の場合、old_value/new_value、差分ハイライト）
- **実行条件**: 管理者のみ

### 10.3 監査ログCSV出力
- **CSV形式**: ヘッダー（日時、ユーザー名、メールアドレス、操作、対象、エンティティID、IPアドレス、ユーザーエージェント）、BOM付きUTF-8、日時形式（UTC/ISO 8601）
- **実行条件**: 管理者のみ

### 10.4 自動記録対象
- **記録対象**: 案件管理（作成/更新/削除）、工数入力（作成/更新/削除）、請求書（作成/確定）、資料管理（アップロード/削除）、注意点管理（作成/更新/削除）、マスタ管理（作成/更新/削除）、管理者機能（ユーザー有効化/無効化/削除）、ログイン/ログアウト
- **記録除外**: ユーザー情報取得、集計API、CORSプリフライトリクエスト（OPTIONS）

---

## 11. バックアップ・復旧

### 11.1 バックアップ作成
- **入力項目**: バックアップ名（必須）、説明、バックアップ種別（full/partial）、対象テーブル（partial時必須）
- **対応テーブル**: users, projects, worklogs, invoices, invoice_items, materials, master_chuiten, master_chuiten_category, master_work_category, master_kishyu, master_nounyusaki, master_shinchoku, system_settings, audit_logs
- **バックアップ形式**: JSON、ローカルファイルシステム（`backend/backups/`）、ファイル名（`backup_YYYYMMDD_HHMMSS_full.json`）、サイズ制限500MB
- **実行条件**: 管理者のみ

### 11.2 バックアップ一覧表示
- **表示項目**: バックアップ名、説明、種別（全体/部分）、対象テーブル、ファイルサイズ、ステータス（completed/failed/in_progress）、作成日時、作成者、復旧日時、復旧者
- **ソート**: デフォルト作成日時降順
- **実行条件**: 管理者のみ

### 11.3 データ復旧
- **パラメータ**: バックアップID（必須）、復旧対象テーブル（未指定で全テーブル復旧）
- **処理**: トランザクション開始、対象テーブルのデータ削除、バックアップファイルからデータ復元、トランザクションコミット
- **復旧オプション**: 全体復旧（全テーブル）、部分復旧（指定テーブルのみ）
- **実行条件**: 管理者のみ

### 11.4 バックアップ削除
- **処理**: 削除確認ダイアログ、ファイルシステムからファイル削除、backupsテーブルからレコード削除
- **実行条件**: 管理者のみ

### 11.5 セキュリティ対策
- **パストラバーサル対策**: バックアップファイルパスを`validate_backup_path`関数で検証、`backend/backups/`ディレクトリ外へのアクセス拒否
- **アクセス制御**: 全バックアップAPI操作は管理者のみ実行可能、`is_admin=true`チェック

---

## 12. 管理者機能

### 12.1 全ユーザー一覧
- **表示項目**: ユーザー名、メールアドレス、管理者権限（is_admin）、アカウント状態（is_active）、登録日時、最終ログイン
- **フィルタリング**: アカウント状態（有効/無効）、管理者権限
- **実行条件**: 管理者のみ

### 12.2 ユーザー有効化
- **処理**: usersテーブルの`is_active`をTrueに更新
- **実行条件**: 管理者のみ

### 12.3 ユーザー無効化
- **処理**: 無効化確認ダイアログ、usersテーブルの`is_active`をFalseに更新
- **無効化の影響**: ログイン不可（既存セッションも無効）、API呼び出しは認証エラー、過去のデータは保持
- **実行条件**: 管理者のみ

### 12.4 ユーザー削除
- **削除条件**: 管理者のみ、工数データ等が紐づいている場合は削除不可（外部キー制約）
- **処理**: 削除確認ダイアログ、usersテーブルからレコード削除

---

## 13. システム設定

### 13.1 工数の丸め設定
- **設定項目**: 丸め方法（up/down/round: 切り上げ/切り捨て/四捨五入）、丸め単位（1.0/0.5/0.25: 1時間/30分/15分単位）
- **処理**: system_settingsテーブルを更新（rounding_method, rounding_unit）
- **実行条件**: 管理者のみ

---

## 14. 画面一覧

### 14.1 認証画面
- `/login` - ログイン
- `/register` - 登録

### 14.2 ダッシュボード
- `/dashboard` - 工数サマリー・案件推移グラフ

### 14.3 案件管理
- `/projects` - 案件一覧
- `/projects/[id]` - 案件詳細
- `/projects/new` - 案件作成
- `/projects/[id]/edit` - 案件編集
- `/projects/trash` - ゴミ箱

### 14.4 工数管理
- `/worklogs` - 工数入力
- `/worklogs/[id]/edit` - 工数編集

### 14.5 請求管理
- `/invoices` - 請求書一覧

### 14.6 資料管理
- `/materials` - 資料一覧

### 14.7 注意点管理
- `/chuiten` - 注意点一覧

### 14.8 マスタ管理
- `/masters` - マスタ管理トップ
- `/masters/sagyou-kubun` - 作業区分マスタ
- `/masters/machine-series` - 機種マスタ
- `/masters/shinchoku` - 進捗マスタ
- `/masters/toiawase` - 問い合わせマスタ

### 14.9 集計・分析
- `/aggregations` - 工数集計

### 14.10 システム設定
- `/settings/rounding` - 丸め設定

### 14.11 管理者機能
- `/admin-panel-secret` - 管理者パネル
- `/audit-logs` - 監査ログ一覧
- `/backups` - バックアップ一覧
